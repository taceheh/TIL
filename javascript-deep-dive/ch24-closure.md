# [JS] 24장. 클로저 (Closure)

## 1. 클로저란? (Definition)
> "함수가 선언된 렉시컬 환경을 기억하여, 함수가 스코프 밖에서 실행될 때도 그 환경에 접근할 수 있는 것"

- **핵심 키워드**: `렉시컬 스코프`, `실행 컨텍스트`, `가비지 컬렉터(GC)`
- 책에 나오는 MDN 정의만 적지 말고, **내가 이해한 문장**으로 한 줄 요약을 꼭 적어보세요.
  - 변수나 함수의 유효 범위와 같은 공간의 개념보다 그 공간을 **"어떤 기준으로 연결할 것인가?"** 에 대한 **규칙(Rule)** 에 가까운 것 같다.

## 2. 핵심 전제 지식 (Prerequisites)
*클로저는 아래 두 가지 자바스크립트의 특성이 결합되어 나타나는 현상이다.*

### 2.1 렉시컬 스코프 (Lexical Scope)
- **정의**: 함수를 어디서 **호출**했는지가 아니라, 어디서 **정의**했는지에 따라 상위 스코프를 결정하는 것. (다른 말로 '정적 스코프'라고도 함)
- **핵심**: 자바스크립트는 렉시컬 스코프를 따르므로, 함수가 정의되는 시점에 상위 스코프가 정적으로 결정되고 변하지 않는다.

```javascript
const x = 1;

function foo() {
  const x = 10;
  bar();
}

function bar() {
  console.log(x);
}

foo(); // ?
bar(); // ?
```
- **결과**: 둘 다 1이 출력된다. 이유: bar 함수는 전역에서 정의되었다. 따라서 bar의 상위 스코프는 전역 스코프다. foo 안에서 호출되었다고 해서 상위 스코프가 foo로 바뀌지 않는다.

### 2.2 함수 객체의 내부 슬롯 `[[Environment]]`
- 함수가 생성될 때 자신이 정의된 환경(상위 스코프)을 어떻게 기억하는지 간단히 정리.

### 2.3 렉시컬 스코프의 동작 원리 (Mechanism)
1. **객체 선언** : 함수가 정의될 때, **현재 실행 중인 렉시컬 환경(상위 스코프)** 의 참조값이 함수 객체의 [[Environment]] 내부 슬롯에 저장
2. **호출** : 함수가 호출되면 실행 컨텍스트가 생성되고, 그 안에 **새로운 렉시컬 환경이 '생성'**, 함수 내부의 변수들이 이 환경(레코드)에 저장
3. **참조** : 방금 만든 **새로운 렉시컬 환경의 '외부 렉시컬 환경에 대한 참조(Link)'** 를 결정할 때, 아까 1번에서 [[Environment]]에 저장해뒀던 그 값을 가져와서 연결

## 3. 클로저의 동작 원리 (Mechanism)
*이 부분이 '딥다이브' 공부의 핵심입니다.*

- **질문**: 외부 함수가 종료(pop)되어 콜 스택에서 사라졌는데, 어떻게 내부 함수가 외부 함수의 변수를 참조할 수 있을까?
- **답변**: 가비지 컬렉터(GC)가 누군가 참조하고 있는 메모리 공간을 해제하지 않는 원리를 설명. (그림이나 도식화를 곁들이면 베스트!)

## 4. 클로저의 활용 사례 (Use Cases)
*실무에서 왜 쓰는지 정리합니다.*

### 4.1 상태 유지 (State Maintenance)
- 예제 코드: `toggle` 버튼이나 `counter` 만들기.
- 전역 변수를 쓰지 않고 변수를 은닉(Encapsulation)하는 방법.

### 4.2 정보 은닉 (Information Hiding)
- 자바의 `private` 키워드 흉내 내기.

## 5. 자주 발생하는 실수 (Common Mistakes)
*책 후반부에 나오는 `var`와 `for`문 예제입니다.*

```javascript
var funcs = [];

for (var i = 0; i < 3; i++) {
  funcs[i] = function () { return i; };
}
// 여기서 왜 0, 1, 2가 안 나오고 3, 3, 3이 나오는지 설명

## 6. 😵‍💫 헷갈렸던 부분 & 의문점

### 6.1 스코프와 헷갈림
- **의문:** 렉시컬 스코프랑 클로저랑 같은 말 아닌가?
- **해결:**
    - **렉시컬 스코프**는 "변수를 어디서 찾을지 결정하는 **규칙(Rule)**"이고,
    - **클로저**는 그 규칙을 이용해서 "이미 사라진 환경을 기억하는 **현상(Phenomenon)**" 혹은 그 함수 자체를 말한다.
    - 엄밀히 다르다!

### 6.2 가비지 컬렉터(GC) 동작 방식
- **의문:** 함수가 끝나면 내부 변수는 다 지워져야 하는 거 아닌가? 왜 살아있지?
- **이해:** 가비지 컬렉터는 **"누군가 참조하고 있는 메모리"**는 지우지 않는다. 내부 함수가 외부 함수의 변수를 잡고 있고, 그 내부 함수가 밖으로 반환되어 어딘가에서 쓰이고 있다면(참조된다면), GC는 그 환경을 지우지 않는다.
